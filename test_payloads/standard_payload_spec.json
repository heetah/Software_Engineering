{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Coder Agent Universal Payload Specification",
  "description": "Universal payload structure for architect-agent to send to coder-agent. Defines the schema and rules that ALL payloads must follow, regardless of project type. NO template-specific examples.",
  "version": "3.0.0",
  
  "usageGuidelines": {
    "purpose": "This specification defines a UNIVERSAL structure that works for ANY project type: frontend-backend APIs, static sites, full-stack apps, microservices, CLIs, libraries, etc.",
    "howToUse": [
      "1. Architect-agent reads user requirements",
      "2. Architect-agent generates payload conforming to this spec",
      "3. Coder-agent receives payload and generates code files",
      "4. ConfigGenerator (Phase 0) auto-generates config files if projectConfig exists",
      "5. Worker agents use configs and contracts to prevent integration bugs"
    ],
    "criticalRule": "This spec contains NO hardcoded examples or template-specific rules. All rules must apply universally to ANY project type."
  },
  
  "schema": {
    "type": "object",
    "required": ["output"],
    "properties": {
      "output": {
        "type": "object",
        "required": ["coder_instructions"],
        "properties": {
          "coder_instructions": {
            "type": "object",
            "required": ["task", "files"],
            "properties": {
              "task": {
                "type": "string",
                "description": "High-level description of what to build (e.g., 'Build a blog system', 'Create a dashboard')"
              },
              "requirements": {
                "type": "string",
                "description": "Optional: Detailed requirements, constraints, and technical specifications"
              },
              "projectConfig": {
                "type": "object",
                "description": "Optional but HIGHLY RECOMMENDED for projects with backend: Centralized configuration that prevents port/URL mismatches",
                "properties": {
                  "backend": {
                    "type": "object",
                    "description": "Backend server configuration - REQUIRED if project has backend",
                    "required": ["host", "port", "protocol"],
                    "properties": {
                      "host": {"type": "string"},
                      "port": {"type": "integer"},
                      "protocol": {"type": "string", "enum": ["http", "https"]},
                      "enableCORS": {"type": "boolean"},
                      "corsOrigins": {"type": "array", "items": {"type": "string"}}
                    }
                  },
                  "frontend": {
                    "type": "object",
                    "properties": {
                      "canBeServedFrom": {"type": "string", "enum": ["any", "same-origin", "specific-port"]},
                      "mustConnectToBackend": {"type": "boolean"}
                    }
                  },
                  "database": {
                    "type": "object",
                    "properties": {
                      "type": {"type": "string", "enum": ["sqlite", "postgresql", "mysql", "mongodb", "redis", "none"]},
                      "file": {"type": "string"},
                      "host": {"type": "string"},
                      "port": {"type": "integer"}
                    }
                  },
                  "testAccounts": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": ["username", "password"],
                      "properties": {
                        "username": {"type": "string"},
                        "password": {"type": "string"},
                        "role": {"type": "string"}
                      }
                    }
                  }
                }
              },
              "files": {
                "type": "array",
                "minItems": 1,
                "items": {
                  "type": "object",
                  "required": ["path", "type", "description"],
                  "properties": {
                    "path": {"type": "string"},
                    "type": {"type": "string", "enum": ["html", "css", "javascript", "python", "java", "go", "other"]},
                    "description": {"type": "string"},
                    "dependencies": {"type": "array", "items": {"type": "string"}}
                  }
                }
              },
              "contracts": {
                "type": "object",
                "properties": {
                  "api": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": ["endpoint", "producers", "consumers"],
                      "properties": {
                        "endpoint": {"type": "string"},
                        "description": {"type": "string"},
                        "request": {},
                        "response": {},
                        "producers": {"type": "array"},
                        "consumers": {"type": "array"}
                      }
                    }
                  },
                  "modules": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": ["name", "file", "exports", "importers"],
                      "properties": {
                        "name": {"type": "string"},
                        "file": {"type": "string"},
                        "exports": {"type": "object"},
                        "importers": {"type": "array"}
                      }
                    }
                  },
                  "dom": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": ["requiredElements", "producers", "consumers"],
                      "properties": {
                        "requiredElements": {"type": "array"},
                        "producers": {"type": "array"},
                        "consumers": {"type": "array"}
                      }
                    }
                  }
                }
              },
              "setup": {
                "type": "object",
                "properties": {
                  "runtime": {"type": "string", "enum": ["browser", "nodejs", "python", "java", "mixed"]},
                  "dependencies": {"type": "object"},
                  "startCommands": {"type": "object"}
                }
              }
            }
          }
        }
      }
    }
  },
  
  "rules": {
    "mandatory": [
      "1. ALWAYS include 'task' and 'files'",
      "2. If project has backend: MUST include projectConfig.backend",
      "3. Contract producers/consumers MUST reference actual file paths"
    ],
    "recommended": [
      "1. Include projectConfig for frontend+backend projects",
      "2. Include contracts.api for all REST/WebSocket endpoints",
      "3. Include contracts.dom for HTML+JS interactions"
    ]
  },
  
  "versionHistory": [
    "v3.0.0 (2025-11-09): Pure universal specification - removed ALL template-specific examples"
  ]
}
